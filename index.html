<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Học Cùng AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #6366f1; --text: #f8fafc; --danger: #ef4444; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        /* AUTH SCREEN */
        #authScreen { position: fixed; inset: 0; background: rgba(15,23,42,0.98); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #334155; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .input-field { width: 100%; padding: 14px; margin: 10px 0; background: #020617; border: 1px solid #334155; color: white; border-radius: 12px; font-size: 16px; }
        .btn-primary { width: 100%; padding: 14px; margin-top: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }

        /* MAIN LAYOUT */
        #app { display: none; width: 100%; height: 100%; position: relative; }
        .sidebar { width: 280px; background: var(--panel); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #334155; z-index: 100; transition: transform 0.3s; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at top right, #1e293b 0%, transparent 40%); width: 100%; }
        
        /* CHAT LIST */
        .chat-list { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        /* MESSAGE BUBBLES */
        .msg { display: flex; gap: 10px; width: 100%; animation: fadeIn 0.3s ease; }
        .msg.user { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #334155; flex-shrink: 0; font-size: 18px; }
        .user .avatar { background: var(--primary); }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; background: #334155; font-size: 15px; line-height: 1.5; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .ai .bubble { border: 1px solid #475569; border-bottom-left-radius: 4px; width: fit-content; }

        /* BADGE COLORS */
        .badge { font-weight: 800; font-size: 12px; display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .badge-blue { color: #60a5fa; } .badge-yellow { color: #facc15; }

        /* INPUT AREA */
        .input-container { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; padding: 0 20px; z-index: 50; }
        .input-box { width: 100%; max-width: 800px; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; display: flex; align-items: flex-end; padding: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); gap: 8px; transition: all 0.3s ease; }
        .input-box:focus-within { border-color: var(--primary); }
        textarea { flex: 1; background: transparent; border: none; color: white; padding: 10px 5px; font-size: 16px; line-height: 20px; resize: none; height: 40px; max-height: 120px; font-family: inherit; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: #94a3b8; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .icon-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .send-btn { background: var(--primary); color: white; }
        .send-btn:hover { background: #4f46e5; }

        /* FILE MANAGER STYLES (NEW) */
        .file-list { margin-top: 15px; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .file-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; margin-bottom: 8px; 
            background: #0f172a; border: 1px solid #334155; border-radius: 10px; 
            transition: 0.2s;
        }
        .file-item:hover { border-color: #475569; background: #151f32; }
        .file-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .file-icon { color: var(--primary); font-size: 18px; flex-shrink: 0; }
        .file-text { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-size: 14px; color: #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 700; }
        .delete-btn { 
            color: #ef4444; cursor: pointer; padding: 5px 8px; 
            border-radius: 6px; transition: 0.2s; 
        }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }

        /* MARKDOWN */
        .md-content table { display: block; overflow-x: auto; white-space: nowrap; margin: 10px 0; border: 1px solid #475569; border-radius: 8px; }
        .md-content th, .md-content td { padding: 10px; border: 1px solid #475569; }
        .md-content th { background: #0f172a; }

        /* MOBILE RESPONSIVE */
        .mobile-header { display: none; }
        .sidebar-overlay { display: none; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; height: 60px; padding: 0 15px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #334155; z-index: 1000; }
            .sidebar { position: fixed; inset: 0; width: 80%; max-width: 300px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 2000; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1500; backdrop-filter: blur(2px); }
            .sidebar-overlay.active { display: block; }
            .chat-list { padding-top: 80px; padding-bottom: 100px; padding-left: 15px; padding-right: 15px; }
            .bubble { max-width: 90%; font-size: 15px; }
            .input-container { bottom: 10px; padding: 0 10px; }
            .input-box { border-radius: 25px; padding: 6px 10px; }
            .subject-bar-wrapper { margin-top: 60px; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box">
            <h2 style="color:var(--primary); margin-bottom:15px; font-size: 24px;"><i class="fa-solid fa-graduation-cap"></i> Học Cùng AI</h2>
            <input id="u" class="input-field" placeholder="Tên đăng nhập">
            <input id="p" type="password" class="input-field" placeholder="Mật khẩu">
            <div id="reg" style="display:none;">
                <select id="role" class="input-field" onchange="toggleCode()">
                    <option value="student">Học sinh</option>
                    <option value="teacher">Giáo viên</option>
                </select>
                <input id="code" class="input-field" placeholder="Mã GV" style="display:none;">
            </div>
            <button class="btn-primary" onclick="auth()">Vào Lớp</button>
            <p onclick="toggleReg()" style="margin-top:15px; color:#94a3b8; font-size:14px; cursor:pointer; text-decoration: underline;">Chuyển Đăng nhập / Đăng ký</p>
        </div>
    </div>

    <div id="app">
        <div class="mobile-header">
            <i class="fa-solid fa-bars" style="font-size:22px; color: #cbd5e1; padding: 10px;" onclick="toggleMenu()"></i>
            <b style="color:var(--primary); font-size: 18px;">Lớp Học Thông Minh</b>
            <div style="width: 40px;"></div> 
        </div>

        <div class="sidebar-overlay" onclick="toggleMenu()"></div>

        <nav class="sidebar" id="sidebar">
            <h3 style="color:var(--primary); margin-bottom:30px; font-size: 22px; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-robot"></i> Menu
            </h3>
            <div style="padding:12px; background:rgba(99, 102, 241, 0.1); color: #818cf8; border-radius:10px; margin-bottom:10px; cursor:pointer; font-weight: 600; display:flex; align-items:center; gap:10px;" onclick="location.reload()">
                <i class="fa-solid fa-comments"></i> Chat Mới
            </div>
            <div id="btnUpload" style="padding:12px; border:1px dashed #64748b; border-radius:10px; color:#94a3b8; cursor:pointer; font-weight: 600; display:none; align-items:center; gap:10px;" onclick="openUpload(); toggleMenu();">
                <i class="fa-solid fa-cloud-arrow-up"></i> Quản Lý Tài Liệu
            </div>
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #334155; display:flex; justify-content:space-between; align-items: center;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="width:30px; height:30px; background:#475569; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user"></i></div>
                    <span id="uName" style="color: white; font-weight: 600;">User</span>
                </div>
                <i class="fa-solid fa-right-from-bracket" style="color:#ef4444; cursor:pointer; font-size: 20px; padding:10px;" onclick="logout()" title="Đăng xuất"></i>
            </div>
        </nav>

        <main class="main">
            <div class="subject-bar-wrapper" style="padding:15px 20px; display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling: touch;">
                <button class="btn-sub active" onclick="sub('general',this)">Chung</button>
                <button class="btn-sub" onclick="sub('geography',this)">Địa Lý</button>
                <button class="btn-sub" onclick="sub('history',this)">Lịch Sử</button>
                <button class="btn-sub" onclick="sub('math',this)">Toán</button>
                <button class="btn-sub" onclick="sub('literature',this)">Ngữ Văn</button>
                <style>
                    .btn-sub{padding:8px 16px; border-radius:20px; border:1px solid #475569; background:#1e293b; color:#94a3b8; cursor:pointer; white-space:nowrap; transition: 0.2s; font-size: 13px; font-weight: 600; flex-shrink: 0;} 
                    .btn-sub:hover { background: #334155; }
                    .btn-sub.active{background:var(--primary); color:white; border-color:var(--primary); box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);}
                </style>
            </div>

            <div id="chat" class="chat-list">
                <div style="text-align:center; margin-top:60px; color:#64748b;">
                    <div style="width: 80px; height: 80px; background: #1e293b; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #6366f1; border: 1px solid #334155;">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <h3 style="color: #94a3b8; margin-bottom: 5px;">Xin chào!</h3>
                    <p style="font-size: 14px;">Chọn môn học và bắt đầu câu hỏi.</p>
                </div>
            </div>

            <div class="input-container">
                <div class="input-box">
                    <button class="icon-btn" onclick="openUpload()" title="Tải file">
                        <i class="fa-solid fa-paperclip"></i>
                    </button>
                    <textarea id="prompt" placeholder="Nhập câu hỏi..." oninput="autoResize(this)"></textarea>
                    <button class="icon-btn send-btn" onclick="send()">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; backdrop-filter: blur(5px); padding: 20px;">
        <div class="auth-box" style="width:100%; max-width:450px; text-align:left; display:flex; flex-direction:column; max-height:85vh;">
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px; align-items: center;">
                <h3 style="color: var(--primary); margin: 0;"><i class="fa-solid fa-folder-open"></i> Quản Lý Tài Liệu</h3>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('modal').style.display='none'" style="cursor:pointer; color: #94a3b8; font-size: 22px; padding: 5px;"></i>
            </div>
            
            <div style="background: #0f172a; padding: 15px; border-radius: 12px; border: 1px dashed #475569; margin-bottom: 20px;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="upSub" class="input-field" style="margin:0; flex:1; font-size:14px; padding:10px;">
                        <option value="general">Kiến thức chung</option>
                        <option value="geography">Địa Lý</option>
                        <option value="history">Lịch Sử</option>
                        <option value="math">Toán Học</option>
                        <option value="literature">Ngữ Văn</option>
                    </select>
                    <button onclick="document.getElementById('file').click()" style="background:#334155; border:1px solid #475569; color:white; border-radius:10px; width:50px; cursor:pointer;"><i class="fa-solid fa-folder-plus"></i></button>
                </div>
                
                <input type="file" id="file" style="display: none;" onchange="document.getElementById('fileName').innerText = this.files[0]?.name || 'Chưa chọn file'">
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="fileName" style="font-size:12px; color:#94a3b8; font-style:italic; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Chưa chọn file...</span>
                    <button onclick="doUpload()" style="background:var(--primary); color:white; border:none; padding:6px 15px; border-radius:8px; font-size:13px; font-weight:bold; cursor:pointer;">Tải lên</button>
                </div>
                <p id="stt" style="margin-top:8px; font-size:12px; font-weight:600; color:var(--primary); min-height:18px; text-align:center;"></p>
            </div>

            <h4 style="color:#cbd5e1; font-size:14px; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px;">Danh sách đã tải:</h4>
            <div id="fileListContainer" class="file-list">
                </div>
        </div>
    </div>

    <script>
        let currUser=null, currSub='general', isReg=false;
        
        function autoResize(el) { el.style.height='40px'; el.style.height=Math.min(el.scrollHeight,140)+'px'; }
        
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function toggleReg() { isReg=!isReg; document.getElementById('reg').style.display=isReg?'block':'none'; }
        function toggleCode() { document.getElementById('code').style.display = document.getElementById('role').value==='teacher'?'block':'none'; }

        async function auth() {
            const u=document.getElementById('u').value, p=document.getElementById('p').value;
            const body = { username:u, password:p, role:'student', secretCode:'' };
            if(isReg) { body.role=document.getElementById('role').value; body.secretCode=document.getElementById('code').value; }
            try {
                const res = await fetch(isReg?'/register':'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
                const d = await res.json();
                if(d.success) { if(isReg){alert('Đăng ký xong! Mời đăng nhập.');toggleReg();} else login(d.user); } else alert(d.error);
            } catch { alert('Lỗi mạng'); }
        }
        function login(u) { currUser=u; localStorage.setItem('u',JSON.stringify(u)); document.getElementById('authScreen').style.display='none'; document.getElementById('app').style.display='flex'; document.getElementById('uName').innerText=u.username; if(u.role==='teacher') document.getElementById('btnUpload').style.display='flex'; }
        function logout() { localStorage.removeItem('u'); location.reload(); }
        window.onload=()=>{ if(localStorage.getItem('u')) login(JSON.parse(localStorage.getItem('u'))); }

        function sub(s, el) { 
            currSub=s; document.querySelectorAll('.btn-sub').forEach(b=>b.classList.remove('active')); el.classList.add('active'); 
            el.scrollIntoView({behavior: "smooth", inline: "center"});
            document.getElementById('chat').innerHTML+=`<div style="text-align:center; font-size:12px; color:#64748b; margin:15px 0;"><span style="background:#1e293b; padding:4px 12px; border-radius:12px; border:1px solid #334155;">Chuyển sang: ${s.toUpperCase()}</span></div>`; 
            const chat=document.getElementById('chat'); chat.scrollTop=chat.scrollHeight;
        }

        async function send() {
            const el=document.getElementById('prompt'); const txt=el.value.trim(); if(!txt)return;
            const chat=document.getElementById('chat');
            
            chat.innerHTML+=`<div class="msg user"><div class="avatar"><i class="fa-solid fa-user"></i></div><div class="bubble">${txt}</div></div>`;
            el.value=''; autoResize(el); chat.scrollTop=chat.scrollHeight;

            const loadId = 'ld'+Date.now();
            chat.innerHTML+=`<div class="msg ai" id="${loadId}"><div class="avatar"><i class="fa-solid fa-robot"></i></div><div class="bubble" style="color:#94a3b8; font-style:italic;"><i class="fa-solid fa-pen-nib fa-bounce"></i> Đang soạn bài...</div></div>`;
            chat.scrollTop=chat.scrollHeight;

            try {
                const res=await fetch('/ask-ai',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt:txt, subject:currSub})});
                const d=await res.json();
                document.getElementById(loadId).remove();
                
                let headerHTML = '';
                if(d.isFallback) {
                    headerHTML = `<span class="badge badge-yellow"><i class="fa-solid fa-triangle-exclamation"></i> Tài Liệu Ngoài</span>`;
                } else {
                    headerHTML = `<span class="badge badge-blue"><i class="fa-solid fa-book-open"></i> Sách Giáo Khoa</span>`;
                }
                
                let html = `
                <div class="msg ai">
                    <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                    <div class="bubble">
                        <div style="border-bottom:1px solid #475569; padding-bottom:6px; margin-bottom:8px; display:flex;">
                            ${headerHTML}
                        </div>
                        <div class="md-content">${marked.parse(d.answer)}</div>
                    </div>
                </div>`;
                
                chat.innerHTML+=html;
                renderMathInElement(chat, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}], throwOnError: false });
                chat.scrollTop=chat.scrollHeight;
            } catch { document.getElementById(loadId).innerHTML='<span style="color:#ef4444">Lỗi kết nối!</span>'; }
        }

        // --- FILE MANAGER LOGIC ---
        function openUpload(){ document.getElementById('modal').style.display='flex'; loadFiles(); }
        
        async function loadFiles() {
            const res = await fetch('/list-files');
            const files = await res.json();
            const container = document.getElementById('fileListContainer');
            
            if(files.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#64748b; font-size:13px; margin-top:20px;">Chưa có tài liệu nào.</div>';
                return;
            }

            container.innerHTML = files.map(f => {
                // Chỉ hiện nút xóa nếu là Teacher
                const delBtn = (currUser && currUser.role === 'teacher') 
                    ? `<i class="fa-solid fa-trash delete-btn" onclick="deleteFile('${f.name}')" title="Xóa file"></i>` 
                    : '';
                
                return `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon"><i class="fa-regular fa-file-lines"></i></div>
                        <div class="file-text">
                            <span class="file-name">${f.name}</span>
                            <span class="file-meta">${f.subject}</span>
                        </div>
                    </div>
                    ${delBtn}
                </div>`;
            }).join('');
        }

        async function deleteFile(n) { 
            if(confirm("Bạn chắc chắn muốn xóa file này khỏi bộ nhớ?")) { 
                try {
                    await fetch('/delete-file', {
                        method:'POST', 
                        headers:{'role': currUser.role, 'Content-Type':'application/json'}, // Gửi role động
                        body:JSON.stringify({filename:n})
                    }); 
                    loadFiles(); // Refresh list
                } catch { alert("Lỗi khi xóa!"); }
            } 
        }

        async function doUpload() {
            const f=document.getElementById('file').files[0]; if(!f)return alert('Chọn file!');
            const fd=new FormData(); fd.append('file',f); fd.append('role',currUser.role); fd.append('subject',document.getElementById('upSub').value);
            
            const stt = document.getElementById('stt');
            stt.innerText='Đang tải lên & đọc file...'; stt.style.color='#f59e0b';
            
            try { 
                const r=await fetch('/upload-doc',{method:'POST',body:fd}); 
                const d=await r.json(); 
                if(d.success) {
                    stt.innerText='Thành công!'; stt.style.color='#10b981';
                    document.getElementById('file').value = ''; // Reset input
                    document.getElementById('fileName').innerText = 'Chưa chọn file...';
                    loadFiles(); // Refresh list
                } else {
                    stt.innerText='Lỗi: ' + d.error; stt.style.color='#ef4444';
                }
            } catch{alert('Lỗi mạng');}
        }
    </script>
</body>
</html>